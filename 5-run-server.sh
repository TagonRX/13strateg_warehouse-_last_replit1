#!/bin/bash

# ═══════════════════════════════════════════════════════════════════════════
# Шаг 5: Запуск сервера (постоянная работа)
# ═══════════════════════════════════════════════════════════════════════════

set -e

echo "════════════════════════════════════════════════════════════"
echo "  ШАГ 5: ЗАПУСК СЕРВЕРА"
echo "════════════════════════════════════════════════════════════"
echo ""

# Проверка что приложение собрано
if [ ! -d "dist" ]; then
    echo "✗ Приложение не собрано!"
    echo "→ Запустите сначала: ./4-install-app.sh"
    exit 1
fi

# Проверка .env
if [ ! -f ".env" ]; then
    echo "✗ Файл .env не найден!"
    echo "→ Запустите сначала: ./3-setup-database.sh"
    exit 1
fi

echo "→ Остановка старого процесса (если запущен)..."
pm2 delete warehouse 2>/dev/null || true

echo ""
echo "→ Запуск сервера через PM2 с ecosystem.config.cjs..."

# Запуск через ecosystem.config.cjs (правильно загружает .env)
pm2 start ecosystem.config.cjs

# Сохранение для автозапуска
pm2 save
pm2 startup | grep 'sudo' | bash || true

echo ""
echo "════════════════════════════════════════════════════════════"
echo "✓ СЕРВЕР ЗАПУЩЕН!"
echo "════════════════════════════════════════════════════════════"
echo ""

# Получение IP
IP=$(hostname -I 2>/dev/null | awk '{print $1}')
if [ -z "$IP" ]; then
    IP="localhost"
fi

echo "→ Откройте в браузере: http://$IP:5000"
echo ""
echo "→ Данные для входа:"
echo "   Логин:  admin"
echo "   Пароль: admin123"
echo ""
echo "⚠️  ВАЖНО: Измените пароль после первого входа!"
echo ""
echo "════════════════════════════════════════════════════════════"
echo ""
echo "Управление сервером:"
echo "  pm2 status              - статус"
echo "  pm2 logs warehouse      - логи"
echo "  pm2 restart warehouse   - перезапуск"
echo "  pm2 stop warehouse      - остановка"
echo "  pm2 start warehouse     - запуск"
echo ""
echo "Сервер запущен в фоновом режиме и будет"
echo "автоматически запускаться при перезагрузке системы."
echo "════════════════════════════════════════════════════════════"
