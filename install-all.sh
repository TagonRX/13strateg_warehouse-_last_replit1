#!/bin/bash

# ═══════════════════════════════════════════════════════════════════════════
# МАСТЕР-СКРИПТ: Полная автоматическая установка (Шаги 1-9)
# ═══════════════════════════════════════════════════════════════════════════
#
# Этот скрипт запускает ВСЕ шаги установки по очереди
# Все логи сохраняются в файл: installation.log
# ═══════════════════════════════════════════════════════════════════════════

# Определяем папку проекта
SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
cd "$SCRIPT_DIR"

# Файл для логов
LOG_FILE="$SCRIPT_DIR/installation.log"

# Очищаем старый лог-файл
> "$LOG_FILE"

# Функция для логирования
log() {
    echo "$1" | tee -a "$LOG_FILE"
}

# Функция для выполнения шага
run_step() {
    local step_number=$1
    local step_name=$2
    local script_file=$3
    
    log ""
    log "════════════════════════════════════════════════════════════"
    log "  ШАГ $step_number: $step_name"
    log "════════════════════════════════════════════════════════════"
    log ""
    log "→ Время начала: $(date '+%Y-%m-%d %H:%M:%S')"
    log ""
    
    if [ ! -f "$script_file" ]; then
        log "✗ ОШИБКА: Файл $script_file не найден!"
        log ""
        log "УСТАНОВКА ПРЕРВАНА НА ШАГЕ $step_number"
        log "Проверьте файл логов: $LOG_FILE"
        exit 1
    fi
    
    # Запускаем скрипт и сохраняем вывод в лог
    if bash "$script_file" 2>&1 | tee -a "$LOG_FILE"; then
        log ""
        log "✓ Шаг $step_number завершён успешно"
        log "→ Время окончания: $(date '+%Y-%m-%d %H:%M:%S')"
        
        # Создаём маркер успешного завершения
        touch "$SCRIPT_DIR/.step_${step_number}_done"
    else
        local exit_code=$?
        log ""
        log "✗ ОШИБКА на шаге $step_number!"
        log "→ Код ошибки: $exit_code"
        log "→ Время ошибки: $(date '+%Y-%m-%d %H:%M:%S')"
        log ""
        log "════════════════════════════════════════════════════════════"
        log "УСТАНОВКА ПРЕРВАНА НА ШАГЕ $step_number: $step_name"
        log "════════════════════════════════════════════════════════════"
        log ""
        log "📋 ЧТО ДЕЛАТЬ:"
        log ""
        log "1. Откройте файл с логами:"
        log "   cat $LOG_FILE"
        log ""
        log "2. Найдите текст 'ОШИБКА' или 'ERROR'"
        log ""
        log "3. Покажите файл installation.log разработчику"
        log ""
        exit 1
    fi
}

# Начало установки
log "╔══════════════════════════════════════════════════════════════════════════════╗"
log "║                                                                              ║"
log "║         АВТОМАТИЧЕСКАЯ УСТАНОВКА WAREHOUSE MANAGEMENT SYSTEM                 ║"
log "║                                                                              ║"
log "║                         KUBUNTU 25.10 SERVER                                 ║"
log "║                                                                              ║"
log "╚══════════════════════════════════════════════════════════════════════════════╝"
log ""
log "→ Дата и время начала: $(date '+%Y-%m-%d %H:%M:%S')"
log "→ Папка проекта: $SCRIPT_DIR"
log "→ Файл логов: $LOG_FILE"
log "→ Пользователь: $USER"
log "→ Система: $(uname -a)"
log ""
log "⏱️  Примерное время установки: 15-20 минут"
log ""
log "📋 ВСЕ ЛОГИ СОХРАНЯЮТСЯ В ФАЙЛ: installation.log"
log ""

# Удаляем старые маркеры
rm -f "$SCRIPT_DIR/.step_"*"_done"

# Запускаем все шаги по очереди
run_step 1 "Установка Node.js 20" "./1-install-node.sh"
run_step 2 "Установка PostgreSQL" "./2-install-postgres.sh"
run_step 3 "Настройка базы данных (пароль: 1234q)" "./3-setup-database.sh"
run_step 4 "Установка приложения" "./4-install-app.sh"
run_step 5 "Запуск PM2 сервера" "./5-run-server.sh"
run_step 6 "Настройка Firewall" "./6-configure-firewall.sh"
run_step 7 "Настройка Nginx" "./7-setup-nginx.sh"
run_step 8 "Финальная проверка" "./8-final-check.sh"

# Проверяем нужен ли шаг 9 (исправление .env)
log ""
log "════════════════════════════════════════════════════════════"
log "  ПРОВЕРКА: Нужно ли исправление .env?"
log "════════════════════════════════════════════════════════════"
log ""

if sudo ss -tulpn 2>/dev/null | grep -q ":5000"; then
    log "✓ Порт 5000 слушается - всё работает!"
    log "→ Шаг 9 (исправление) не требуется"
else
    log "⚠ Порт 5000 не слушается - запускаем исправление"
    run_step 9 "Исправление .env и перезапуск" "./9-fix-env.sh"
fi

# Завершение
log ""
log "╔══════════════════════════════════════════════════════════════════════════════╗"
log "║                                                                              ║"
log "║                    ✅ УСТАНОВКА ЗАВЕРШЕНА УСПЕШНО!                           ║"
log "║                                                                              ║"
log "╚══════════════════════════════════════════════════════════════════════════════╝"
log ""
log "→ Дата и время завершения: $(date '+%Y-%m-%d %H:%M:%S')"
log ""

# Получаем IP адрес
SERVER_IP=$(hostname -I | awk '{print $1}')

log "════════════════════════════════════════════════════════════"
log "📱 ДОСТУП К ПРИЛОЖЕНИЮ:"
log "════════════════════════════════════════════════════════════"
log ""
log "  🌐 Через Nginx (рекомендуется):"
log "     http://$SERVER_IP"
log ""
log "  🔧 Прямой доступ:"
log "     http://$SERVER_IP:5000"
log ""
log "  👤 Данные для входа:"
log "     Логин:  admin"
log "     Пароль: admin123"
log ""
log "════════════════════════════════════════════════════════════"
log ""
log "💡 ПОЛЕЗНЫЕ КОМАНДЫ:"
log ""
log "  Просмотр логов PM2:"
log "    pm2 logs warehouse"
log ""
log "  Перезапуск приложения:"
log "    pm2 restart warehouse"
log ""
log "  Статус PM2:"
log "    pm2 status"
log ""
log "  Просмотр логов установки:"
log "    cat $LOG_FILE"
log ""
log "════════════════════════════════════════════════════════════"
log ""
log "📋 ФАЙЛ С ПОЛНЫМИ ЛОГАМИ:"
log "   $LOG_FILE"
log ""
log "   Если что-то не работает, покажите этот файл разработчику!"
log ""

echo ""
echo "╔══════════════════════════════════════════════════════════════╗"
echo "║                                                              ║"
echo "║  🎉 Готово! Откройте браузер и перейдите по адресу:          ║"
echo "║                                                              ║"
echo "║     http://$SERVER_IP                              ║"
echo "║                                                              ║"
echo "╚══════════════════════════════════════════════════════════════╝"
echo ""
